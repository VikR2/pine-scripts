//@version=6
strategy("80m Cycles Strategy", overlay=true,
     default_qty_type=strategy.fixed,
     default_qty_value=1,
     initial_capital=10000,
     pyramiding=0)

//------------------------------------------------------------------------------
// INPUTS
//------------------------------------------------------------------------------
i_startHour = input.int(7, "Session Start Hour", minval=0, maxval=23)
i_endHour = input.int(16, "Session End Hour", minval=0, maxval=23)
i_stopPts = input.float(30.0, "Stop Loss (points)", minval=1)
i_tpPts = input.float(70.0, "Take Profit (points)", minval=1)
i_tz = "America/New_York"

//------------------------------------------------------------------------------
// TIME CALCULATIONS
//------------------------------------------------------------------------------
currentHour = hour(time, i_tz)
currentMin = minute(time, i_tz)
inSession = currentHour >= i_startHour and currentHour < i_endHour

// Calculate cycle phase using modulo
totalMins = inSession ? (currentHour - i_startHour) * 60 + currentMin : -1
cycleMin = totalMins >= 0 ? totalMins % 80 : -1

inPhase1 = inSession and cycleMin >= 0 and cycleMin < 40   // Accumulation
inPhase2 = inSession and cycleMin >= 40                      // Execution

// Detect phase changes
enteringPhase1 = inPhase1 and not inPhase1[1]
enteringPhase2 = inPhase2 and not inPhase2[1]

//------------------------------------------------------------------------------
// RANGE TRACKING (Manual - no ta.highest/lowest)
//------------------------------------------------------------------------------
var float rangeHigh = na
var float rangeLow = na

if enteringPhase1
    rangeHigh := high
    rangeLow := low

if inPhase1
    rangeHigh := math.max(nz(rangeHigh, high), high)
    rangeLow := math.min(nz(rangeLow, low), low)

//------------------------------------------------------------------------------
// SWEEP DETECTION
//------------------------------------------------------------------------------
validRange = not na(rangeHigh) and not na(rangeLow)
sweepHigh = inPhase2 and validRange and high > rangeHigh
sweepLow = inPhase2 and validRange and low < rangeLow

// One trade per cycle
var bool tradedThisCycle = false
if enteringPhase1
    tradedThisCycle := false

//------------------------------------------------------------------------------
// STRATEGY ENTRIES
//------------------------------------------------------------------------------
canTrade = not tradedThisCycle and strategy.position_size == 0

longSignal = sweepLow and canTrade
shortSignal = sweepHigh and canTrade

if longSignal
    tradedThisCycle := true
    strategy.entry("Long", strategy.long)

if shortSignal
    tradedThisCycle := true
    strategy.entry("Short", strategy.short)

//------------------------------------------------------------------------------
// EXITS
//------------------------------------------------------------------------------
if strategy.position_size > 0
    strategy.exit("XL", "Long",
         stop=strategy.position_avg_price - i_stopPts,
         limit=strategy.position_avg_price + i_tpPts)

if strategy.position_size < 0
    strategy.exit("XS", "Short",
         stop=strategy.position_avg_price + i_stopPts,
         limit=strategy.position_avg_price - i_tpPts)

// Close at end of day
if not inSession and strategy.position_size != 0
    strategy.close_all("EOD")

//------------------------------------------------------------------------------
// VISUALS
//------------------------------------------------------------------------------
plotshape(longSignal, "Long", shape.triangleup, location.belowbar, color.lime, size=size.normal)
plotshape(shortSignal, "Short", shape.triangledown, location.abovebar, color.red, size=size.normal)
plot(inPhase2 and validRange ? rangeHigh : na, "40m High", color.red, 2)
plot(inPhase2 and validRange ? rangeLow : na, "40m Low", color.green, 2)
bgcolor(inPhase1 ? color.new(color.yellow, 90) : inPhase2 ? color.new(color.blue, 93) : na)
